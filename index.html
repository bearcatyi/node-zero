<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>JSON è§£æä¸å±‚çº§ç­›é€‰ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-2: #60a5fa;
      --border: #374151;
      --warn: #f59e0b;
      --error: #ef4444;
      --code-bg: #0b1220;
      --code-border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(96,165,250,0.15), transparent) no-repeat,
                  radial-gradient(1000px 600px at 120% 30%, rgba(34,197,94,0.12), transparent) no-repeat,
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 20px clamp(16px, 3vw, 28px);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(17,24,39,0.85), rgba(17,24,39,0.55) 60%, transparent);
      z-index: 10;
    }
    h1 {
      margin: 0 0 6px;
      font-size: clamp(18px, 2.6vw, 24px);
      letter-spacing: 0.2px;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
    }
    .container {
      padding: 16px clamp(16px, 3vw, 28px) 40px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 1080px) {
      .container {
        grid-template-columns: 420px 1fr;
        align-items: start;
      }
    }
    .panel {
      background: linear-gradient(180deg, rgba(17,24,39,0.8), rgba(17,24,39,0.6));
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: clip;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .panel h2 {
      margin: 0;
      padding: 14px 16px;
      font-size: 15px;
      letter-spacing: .2px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
    }
    .panel-body {
      padding: 14px 16px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(34,197,94,0.18), rgba(34,197,94,0.12));
      color: #d1fae5;
      cursor: pointer;
      font-size: 14px;
      transition: 0.15s ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(34,197,94,0.15); }
    .btn:active { transform: translateY(0); }
    .btn.secondary {
      background: linear-gradient(180deg, rgba(96,165,250,0.18), rgba(96,165,250,0.12));
      color: #dbeafe;
    }
    .btn.warn {
      background: linear-gradient(180deg, rgba(245,158,11,0.18), rgba(245,158,11,0.12));
      color: #fef3c7;
    }
    .btn.ghost {
      background: transparent;
      color: var(--text);
    }
    .path {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      color: #c7d2fe;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .muted { color: var(--muted); }
    pre {
      margin: 0;
      padding: 14px;
      background: var(--code-bg);
      border-top: 1px solid var(--code-border);
      border-radius: 0 0 14px 14px;
      overflow: auto;
      max-height: 70vh;
      font-size: 13px;
      line-height: 1.5;
    }
    code { color: #e2e8f0; }
    .k { color: #93c5fd; }
    .str { color: #86efac; }
    .num { color: #fca5a5; }
    .bool { color: #fcd34d; }
    .null { color: #a5b4fc; font-style: italic; }
    .type-hint {
      font-size: 12px;
      color: var(--muted);
      margin-left: 6px;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .select-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    select {
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      min-width: 220px;
      font-size: 14px;
    }
    .footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .copy {
      cursor: pointer;
      color: #a7f3d0;
      text-decoration: underline dotted;
    }
    .input-area textarea {
      width: 100%;
      min-height: 140px;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      resize: vertical;
    }
    .tag {
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>JSON è§£æä¸å±‚çº§ç­›é€‰ Demo</h1>
    <div class="sub">ç‚¹å‡»â€œ+ ç­›é€‰â€é€‰æ‹©å½“å‰èŠ‚ç‚¹çš„é”®/ç´¢å¼•ï¼Œé€çº§æ·±å…¥æŸ¥çœ‹å¯¹åº” valueã€‚</div>
  </header>

  <div class="container">
    <!-- å·¦ä¾§ï¼šæ§åˆ¶ä¸è¾“å…¥ -->
    <section class="panel">
      <h2>æ§åˆ¶åŒº</h2>
      <div class="panel-body">
        <div class="controls">
          <button id="btnAdd" class="btn" title="æ·±å…¥ä¸€å±‚"><span>â•</span> + ç­›é€‰</button>
          <button id="btnBack" class="btn secondary" title="è¿”å›ä¸Šä¸€æ­¥">â†© è¿”å›</button>
          <button id="btnRoot" class="btn warn" title="å›åˆ°æ ¹">âŸ² å›åˆ°æ ¹</button>
        </div>

        <div class="select-row">
          <div class="tag">å½“å‰è·¯å¾„</div>
          <div id="pathView" class="path" title="ç‚¹å‡»å¤åˆ¶è·¯å¾„"></div>
          <button id="copyPath" class="btn ghost" title="å¤åˆ¶è·¯å¾„">ğŸ“‹ å¤åˆ¶</button>
        </div>

        <div class="input-area">
          <div class="select-row" style="margin-top:6px;">
            <div class="tag">æ•°æ®æº</div>
            <span class="type-hint">å¯ç¼–è¾‘ï¼Œç‚¹å‡»â€œåº”ç”¨æ•°æ®â€é‡æ–°è½½å…¥</span>
          </div>
          <textarea id="jsonInput"></textarea>
          <div class="controls" style="margin-top:8px;">
            <button id="btnApply" class="btn secondary">âœ… åº”ç”¨æ•°æ®</button>
            <span id="status" class="hint"></span>
          </div>
        </div>
      </div>
      <div class="footer">
        æ”¯æŒå¯¹è±¡ä¸æ•°ç»„ç­›é€‰ï¼›å¶å­èŠ‚ç‚¹æ— æ³•ç»§ç»­ç­›é€‰å°†æç¤ºã€‚è·¯å¾„æ ¼å¼ç¤ºä¾‹ï¼šroot.users[2].profile.name
      </div>
    </section>

    <!-- å³ä¾§ï¼šå±•ç¤º -->
    <section class="panel">
      <h2>å½“å‰å±•ç¤º <span id="typeHint" class="type-hint"></span></h2>
      <pre><code id="viewer"></code></pre>
    </section>
  </div>

  <script>
    // æµ‹è¯• JSONï¼šç»“æ„å¤æ‚ä½†æ¯ä¸ª value ä¸å¤§
    const TEST_DATA = {
      meta: {
        version: "1.4.2",
        generatedAt: "2025-10-30T08:12:00Z",
        tags: ["demo", "json", "filter"],
        flags: { archived: false, experimental: true },
      },
      stats: {
        users: 1287,
        active: 958,
        regions: ["NA", "EU", "APAC"],
        loadAvg: [0.42, 0.58, 0.36],
      },
      users: [
        {
          id: "u_0001",
          profile: { name: "Alice", age: 29, roles: ["admin", "dev"] },
          preferences: { theme: "dark", lang: "en", shortcuts: { save: "Ctrl+S", run: "Ctrl+R" } },
          lastLogin: { time: "2025-10-29T12:00:00Z", ip: "10.0.0.1" },
        },
        {
          id: "u_0002",
          profile: { name: "Bob", age: 34, roles: ["editor"] },
          preferences: { theme: "light", lang: "zh-CN", notifications: { email: true, sms: false } },
          lastLogin: { time: "2025-10-29T18:33:10Z", ip: "10.0.0.2" },
        },
        {
          id: "u_0003",
          profile: { name: "Carol", age: 25, roles: ["viewer"], contacts: [{ type: "email", value: "c@example.com" }] },
          preferences: { theme: "dark", lang: "ja", layout: { density: "compact", sidebar: true } },
          lastLogin: { time: "2025-10-28T06:01:44Z", ip: "10.0.0.3" },
        }
      ],
      settings: {
        features: { payments: true, realtime: true, audit: false },
        limits: { maxProjects: 20, maxMembers: 100 },
        themes: [
          { id: "t1", name: "Ocean", colors: { primary: "#1e3a8a", accent: "#22d3ee" } },
          { id: "t2", name: "Forest", colors: { primary: "#065f46", accent: "#84cc16" } },
        ],
      },
      content: {
        pages: [
          { id: "p_home", title: "Home", blocks: [{ type: "hero" }, { type: "grid" }] },
          { id: "p_about", title: "About", blocks: [{ type: "md", src: "about.md" }] }
        ],
        media: {
          images: [{ id: "img_1", w: 1200, h: 630 }, { id: "img_2", w: 800, h: 600 }],
          videos: [{ id: "vid_1", dur: 12 }, { id: "vid_2", dur: 35 }],
        }
      },
      pipelines: [
        { id: "pl_ingest", steps: [{ op: "fetch" }, { op: "normalize" }, { op: "store" }] },
        { id: "pl_export", steps: [{ op: "select" }, { op: "render" }, { op: "upload" }] }
      ],
      map: {
        nodes: {
          n1: { label: "Start", links: ["n2", "n3"] },
          n2: { label: "Process", links: ["n4"] },
          n3: { label: "Alt", links: [] },
          n4: { label: "End", links: [] }
        }
      }
    };

    // çŠ¶æ€
    let rootData = TEST_DATA;
    let stack = []; // æ¯æ­¥: { key, value, type }
    const viewer = document.getElementById('viewer');
    const typeHint = document.getElementById('typeHint');
    const pathView = document.getElementById('pathView');
    const btnAdd = document.getElementById('btnAdd');
    const btnBack = document.getElementById('btnBack');
    const btnRoot = document.getElementById('btnRoot');
    const btnApply = document.getElementById('btnApply');
    const status = document.getElementById('status');
    const copyPath = document.getElementById('copyPath');
    const jsonInput = document.getElementById('jsonInput');

    // åˆå§‹åŒ–è¾“å…¥æ¡†
    jsonInput.value = JSON.stringify(TEST_DATA, null, 2);

    // å·¥å…·å‡½æ•°
    const isObject = v => Object.prototype.toString.call(v) === '[object Object]';
    const isArray = Array.isArray;
    const getType = v => v === null ? 'null' : isArray(v) ? 'array' : typeof v;
    const atCurrent = () => stack.length ? stack[stack.length-1].value : rootData;

    function currentPathString() {
      if (!stack.length) return 'root';
      let parts = ['root'];
      for (const seg of stack) {
        if (typeof seg.key === 'number') {
          parts[parts.length-1] += `[${seg.key}]`;
        } else if (/^[A-Za-z_$][A-Za-z0-9_$]*$/.test(seg.key)) {
          parts.push(seg.key);
        } else {
          parts.push(`["${String(seg.key).replace(/"/g, '\\"')}"]`);
        }
      }
      return parts.join('.');
    }

    function syntaxHighlight(jsonString) {
      // ç®€æ˜“é«˜äº®
      return jsonString
        .replace(/(&|<|>)/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))
        .replace(/"([^"\\]|\\.)*"\s*:/g, m => `<span class="k">${m}</span>`)
        .replace(/"(?:[^"\\]|\\.)*"/g, m => `<span class="str">${m}</span>`)
        .replace(/\b(true|false)\b/g, m => `<span class="bool">${m}</span>`)
        .replace(/\b(null)\b/g, m => `<span class="null">${m}</span>`)
        .replace(/\b-?\d+(\.\d+)?([eE][+-]?\d+)?\b/g, m => `<span class="num">${m}</span>`);
    }

    function render() {
      const data = atCurrent();
      const type = getType(data);
      typeHint.textContent = `ç±»å‹ï¼š${type}`;
      pathView.textContent = currentPathString();

      try {
        const pretty = JSON.stringify(data, (key, value) => value, 2);
        viewer.innerHTML = syntaxHighlight(pretty);
        status.textContent = '';
      } catch (e) {
        viewer.textContent = 'æ¸²æŸ“å¤±è´¥ï¼š' + e.message;
      }
      
      // æ§åˆ¶æŒ‰é’®çŠ¶æ€
      const canDrill = isObject(data) || isArray(data);
      btnAdd.disabled = !canDrill;
      btnBack.disabled = stack.length === 0;
      btnRoot.disabled = stack.length === 0;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼æç¤º
      btnAdd.title = canDrill ? 'æ·±å…¥ä¸€å±‚ï¼ˆé€‰æ‹©é”®/ç´¢å¼•ï¼‰' : 'å½“å‰æ˜¯å¶å­èŠ‚ç‚¹ï¼Œæ— æ³•ç»§ç»­ç­›é€‰';
    }
    
    function promptSelectKey(container) {
      // åˆ›å»ºä¸€ä¸ªè½»é‡çš„æµ®å±‚é€‰æ‹©å™¨
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.35)';
      overlay.style.backdropFilter = 'blur(2px)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      
      const panel = document.createElement('div');
      panel.style.background = '#0b1220';
      panel.style.border = '1px solid #374151';
      panel.style.borderRadius = '12px';
      panel.style.minWidth = '320px';
      panel.style.maxWidth = '90vw';
      panel.style.boxShadow = '0 20px 60px rgba(0,0,0,0.4)';
      panel.style.padding = '14px';
      
      const title = document.createElement('div');
      title.style.fontSize = '14px';
      title.style.marginBottom = '8px';
      const isArr = isArray(container);
      title.textContent = isArr ? 'é€‰æ‹©ä¸€ä¸ªæ•°ç»„ç´¢å¼•' : 'é€‰æ‹©ä¸€ä¸ªå¯¹è±¡é”®';
      
      const select = document.createElement('select');
      select.style.width = '100%';
      
      const keys = isArr ? container.map((_, i) => i) : Object.keys(container);
      
      if (keys.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = 'å½“å‰æ²¡æœ‰å¯é€‰é¡¹ã€‚';
        panel.appendChild(title);
        panel.appendChild(empty);
      } else {
        // é€‰é¡¹æ¸²æŸ“ï¼šæ˜¾ç¤ºé”®ä¸ç±»å‹æç¤º
        const frag = document.createDocumentFragment();
        keys.forEach(k => {
          const v = container[k];
          const opt = document.createElement('option');
          const t = getType(v);
          opt.value = String(k);
          opt.textContent = isArr ? `[${k}] : ${t}` : `${k} : ${t}`;
          frag.appendChild(opt);
        });
        select.appendChild(frag);
        panel.appendChild(title);
        panel.appendChild(select);
      }
      
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.marginTop = '10px';
      const ok = document.createElement('button');
      ok.className = 'btn secondary';
      ok.textContent = 'ç¡®å®š';
      const cancel = document.createElement('button');
      cancel.className = 'btn ghost';
      cancel.textContent = 'å–æ¶ˆ';
      row.appendChild(ok);
      row.appendChild(cancel);
      panel.appendChild(row);
      
      overlay.appendChild(panel);
      document.body.appendChild(overlay);
      
      return new Promise((resolve) => {
        const cleanup = () => overlay.remove();
        cancel.onclick = () => {
          cleanup();
          resolve(null);
        };
        ok.onclick = () => {
          if (!select.options.length) {
            cleanup();
            resolve(null);
            return;
          }
          let key = select.value;
          if (isArr) key = Number(key);
          cleanup();
          resolve(key);
        };
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            cleanup();
            resolve(null);
          }
        });
        // é”®ç›˜å¿«æ·
        overlay.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            cleanup();
            resolve(null);
          } else if (e.key === 'Enter') {
            ok.click();
          }
        });
        // èšç„¦
        setTimeout(() => select.focus(), 0);
      });
    }
    
    async function onAdd() {
      const cur = atCurrent();
      if (!(isObject(cur) || isArray(cur))) {
        status.textContent = 'æç¤ºï¼šå½“å‰æ˜¯å¶å­èŠ‚ç‚¹ï¼Œæ— æ³•ç»§ç»­ç­›é€‰ã€‚';
        return;
      }
      const key = await promptSelectKey(cur);
      if (key === null || key === undefined) return;
      const value = cur[key];
      stack.push({ key, value, type: getType(value) });
      render();
    }
    
    function onBack() {
      if (!stack.length) return;
      stack.pop();
      render();
    }
    
    function onRoot() {
      stack = [];
      render();
    }
    
    function applyData() {
      const text = jsonInput.value.trim();
      if (!text) {
        status.textContent = 'è¯·è¾“å…¥ JSON æ•°æ®ã€‚';
        return;
      }
      try {
        const data = JSON.parse(text);
        rootData = data;
        stack = [];
        status.textContent = 'å·²åº”ç”¨æ–°çš„æ•°æ®æºã€‚';
        render();
      } catch (e) {
        status.textContent = 'JSON è§£æå¤±è´¥ï¼š' + e.message;
      }
    }
    
    // å¤åˆ¶è·¯å¾„
    async function copyCurrentPath() {
      const p = currentPathString();
      try {
        await navigator.clipboard.writeText(p);
        status.textContent = 'å·²å¤åˆ¶è·¯å¾„ï¼š' + p;
      } catch {
        // å›é€€æ–¹æ¡ˆ
        const ta = document.createElement('textarea');
        ta.value = p;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        status.textContent = 'å·²å¤åˆ¶è·¯å¾„ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰ï¼š' + p;
      }
    }
    
    // ç‚¹å‡»è·¯å¾„åŒºåŸŸä¹Ÿå¤åˆ¶
    pathView.addEventListener('click', copyCurrentPath);
    copyPath.addEventListener('click', copyCurrentPath);
    
    // äº‹ä»¶ç»‘å®š
    btnAdd.addEventListener('click', onAdd);
    btnBack.addEventListener('click', onBack);
    btnRoot.addEventListener('click', onRoot);
    btnApply.addEventListener('click', applyData);
    
    // åˆæ¬¡æ¸²æŸ“
    render();
  </script>
</body>
</html>
